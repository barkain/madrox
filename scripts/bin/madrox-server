#!/bin/bash
# Madrox HTTP Server Wrapper - Runs the FastAPI orchestrator

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Navigate to the repository root (two levels up from scripts/bin/)
REPO_ROOT="$( cd "$SCRIPT_DIR/../.." && pwd )"
cd "$REPO_ROOT"

# Default configuration
PORT="${ORCHESTRATOR_PORT:-8001}"
MAX_INSTANCES="${MAX_INSTANCES:-10}"
TRANSPORT="${MADROX_TRANSPORT:-http}"

echo "Starting Madrox HTTP server..."
echo "  Port: $PORT"
echo "  Max instances: $MAX_INSTANCES"
echo "  Transport: $TRANSPORT"
echo ""
echo "Press Ctrl+C to stop the server"
echo ""

# Check if we're in a virtual environment or if uv is available
if [ -n "$VIRTUAL_ENV" ]; then
    # Already in a virtual environment, use python directly
    exec python run_orchestrator.py
elif command -v uv >/dev/null 2>&1; then
    # uv is available in PATH
    exec uv run python run_orchestrator.py
elif [ -f "$HOME/.local/bin/uv" ]; then
    # uv is in the common local bin location
    exec "$HOME/.local/bin/uv" run python run_orchestrator.py
else
    # Try to use python directly (assumes dependencies are installed)
    exec python run_orchestrator.py
fi