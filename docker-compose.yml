version: '3.8'

services:
  madrox:
    build:
      context: .
      dockerfile: Dockerfile
    image: madrox-mcp:latest
    container_name: madrox-server

    # Port mapping
    ports:
      - "${ORCHESTRATOR_PORT:-8001}:8001"

    # Environment variables
    environment:
      # Required: Anthropic API key
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}

      # Server configuration
      ORCHESTRATOR_HOST: 0.0.0.0
      ORCHESTRATOR_PORT: 8001

      # Resource limits
      MAX_INSTANCES: ${MAX_INSTANCES:-10}
      MAX_TOKENS_PER_INSTANCE: ${MAX_TOKENS_PER_INSTANCE:-100000}
      MAX_TOTAL_COST: ${MAX_TOTAL_COST:-100.0}
      INSTANCE_TIMEOUT_MINUTES: ${INSTANCE_TIMEOUT_MINUTES:-60}

      # Workspace and logging
      WORKSPACE_DIR: /tmp/claude_orchestrator
      LOG_DIR: /logs
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      # Database
      DATABASE_URL: sqlite:////data/claude_orchestrator.db

    # Volume mounts for persistent data
    volumes:
      # SQLite database persistence
      - madrox-data:/data

      # Logs persistence
      - madrox-logs:/logs

      # Instance workspaces (ephemeral but useful for debugging)
      - madrox-workspaces:/tmp/claude_orchestrator

      # Optional: Mount custom configuration
      # - ./config:/app/config:ro

    # Restart policy
    restart: unless-stopped

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 512M

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Network configuration
    networks:
      - madrox-network

    # Security options
    security_opt:
      - no-new-privileges:true

    # Read-only root filesystem (with writable volumes)
    # Commented out as tmux needs write access
    # read_only: true

    # Tmpfs mounts for temporary data
    tmpfs:
      - /tmp:mode=1777,size=1G
      - /run:mode=755,size=100M

# Named volumes for data persistence
volumes:
  madrox-data:
    driver: local
    name: madrox-data
  madrox-logs:
    driver: local
    name: madrox-logs
  madrox-workspaces:
    driver: local
    name: madrox-workspaces

# Network configuration
networks:
  madrox-network:
    driver: bridge
    name: madrox-network
